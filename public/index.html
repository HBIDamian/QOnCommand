<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>QOnCommand</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="assets/icon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon-16x16.png">
    
    <!-- CSS -->
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/fonts.css">
    <link rel="stylesheet" href="assets/css/app.css">
</head>
<body class="d-flex flex-column min-vh-100">
    <div class="main-container flex-grow-1 py-3 px-3 py-md-4 px-md-4" style="margin-bottom: 2rem;">
        <div class="container-fluid" style="max-width: 1400px; margin: 0 auto;">
            <header class="text-center mb-5 fade-in">
                <h1 class="display-5 fw-bold text-gradient mb-3">QOnCommand</h1>
                <p class="lead fs-6 text-soft">A web-based remote control for Figure53's QLab</p>
            </header>

            <div id="workspace-modal" class="app-modal hidden">
                <div class="app-modal__dialog glass-card p-4 p-md-5 slide-up">
                    <div id="instance-step" class="step-content">
                        <h2 class="h4 text-center text-gradient-sm mb-4">Select QLab Instance</h2>
                        <div id="instance-list" class="list-stack mb-4"></div>
                        <div class="d-grid gap-3 d-md-flex">
                            <button id="refresh-instances-btn" class="btn btn-outline-glass btn-modern flex-grow-1">
                                <span class="me-2">üîÑ</span>Refresh
                            </button>
                            <button id="next-step-btn" class="btn btn-gradient-primary btn-modern flex-grow-1" disabled>
                                Next ‚Üí
                            </button>
                        </div>
                    </div>

                    <div id="workspace-step" class="step-content hidden">
                        <h2 class="h4 text-center text-gradient-sm mb-4">Select Workspace</h2>
                        <div class="glass-card bg-dark-soft border-0 rounded-4 p-3 mb-4">
                            <div class="text-soft small">Instance:</div>
                            <div id="selected-instance-name" class="fw-semibold">None</div>
                        </div>
                        <div id="workspace-list" class="list-stack mb-4"></div>
                        <div class="d-grid gap-3 d-md-flex">
                            <button id="back-step-btn" class="btn btn-outline-glass btn-modern flex-grow-1">‚Üê Back</button>
                            <button id="connect-workspace-btn" class="btn btn-gradient-success btn-modern flex-grow-1" disabled>Connect</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4 g-xl-5">
                <div class="col-lg-8">
                    <div class="vstack gap-4">
                        <section class="glass-card p-4 p-md-5">
                            <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-4 mb-4">
                                <h2 class="h4 fw-semibold mb-0 text-center">Connection Status</h2>
                                <div class="d-flex align-items-center gap-3">
                                    <span id="status-indicator" class="status-dot status-dot-pulse bg-danger"></span>
                                    <span id="status-text" class="fw-medium text-soft">Disconnected</span>
                                </div>
                            </div>
                            <div class="glass-card bg-dark-soft border-0 shadow-none p-4 p-xl-5">
                                <div class="d-flex flex-column flex-xl-row justify-content-between align-items-start align-items-xl-center gap-4 mb-4">
                                    <div>
                                        <h3 class="h5 mb-1">Workspace</h3>
                                        <div id="workspace-name" class="text-soft small">No workspace connected</div>
                                    </div>
                                    <div class="d-flex flex-wrap gap-2">
                                        <button id="change-workspace-btn" class="btn btn-gradient-primary btn-modern">Change Workspace</button>
                                        <button id="disconnect-btn" class="btn btn-gradient-danger btn-modern" style="display:none;">Disconnect</button>
                                    </div>
                                </div>
                                <div id="connection-status" class="connection-status alert alert-danger text-center">
                                    Click "Change Workspace" to connect to QLab
                                </div>
                            </div>
                        </section>

                        <section class="glass-card p-4 p-md-5">
                            <div class="d-flex align-items-center justify-content-between mb-4">
                                <h2 class="h4 fw-semibold mb-0 text-center">Cue Information</h2>
                                <button id="refresh-cue-btn" class="btn btn-soft-secondary btn-sm fw-semibold" title="Refresh">
                                    ‚Üª
                                </button>
                            </div>
                            <div class="vstack gap-3">
                                <div class="cue-highlight current">
                                    <div class="d-flex align-items-center justify-content-between mb-2">
                                        <span class="text-uppercase text-soft fw-semibold small">Current Selected</span>
                                        <span id="current-cue-type" class="badge cue-badge">Loading...</span>
                                    </div>
                                    <div class="d-flex flex-wrap align-items-baseline gap-3">
                                        <div id="current-cue-number" class="cue-number">--</div>
                                        <div id="current-cue-name" class="cue-name flex-grow-1">Loading...</div>
                                    </div>
                                </div>
                                <div class="cue-highlight next">
                                    <div class="d-flex align-items-center justify-content-between mb-2">
                                        <span class="text-uppercase text-soft fw-semibold small">Next Cue</span>
                                        <span id="next-cue-type" class="badge cue-badge cue-badge-next">Loading...</span>
                                    </div>
                                    <div class="d-flex flex-wrap align-items-baseline gap-3">
                                        <div id="next-cue-number" class="cue-number">--</div>
                                        <div id="next-cue-name" class="cue-name flex-grow-1">Loading...</div>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <section class="glass-card p-4 p-md-5">
                            <h2 class="h4 fw-semibold mb-4 text-center">Transport Controls</h2>
                            <div class="d-flex justify-content-center align-items-center flex-wrap transport-stack">
                                <button id="prev-btn" class="btn-icon btn-outline-glass" title="Previous">
                                    <svg viewBox="0 0 24 24" fill="none">
                                        <path d="M8.09015 14.6474C6.30328 13.4935 6.30328 10.5065 8.09015 9.35258L18.8792 2.38548C20.6158 1.26402 22.75 2.72368 22.75 5.0329V18.9671C22.75 21.2763 20.6158 22.736 18.8792 21.6145L8.09015 14.6474Z" fill="currentColor"></path>
                                        <path d="M2 5C2 4.58579 2.33579 4.25 2.75 4.25C3.16421 4.25 3.5 4.58579 3.5 5V19C3.5 19.4142 3.16421 19.75 2.75 19.75C2.33579 19.75 2 19.4142 2 19V5Z" fill="currentColor"></path>
                                    </svg>
                                </button>
                                <button id="stop-btn" class="btn-icon btn-gradient-danger" title="Stop">
                                    <svg viewBox="0 0 24 24" fill="none">
                                        <path d="M2 12C2 7.28595 2 4.92893 3.46447 3.46447C4.92893 2 7.28595 2 12 2C16.714 2 19.0711 2 20.5355 3.46447C22 4.92893 22 7.28595 22 12C22 16.714 22 19.0711 20.5355 20.5355C19.0711 22 16.714 22 12 22C7.28595 22 4.92893 22 3.46447 20.5355C2 19.0711 2 16.714 2 12Z" fill="currentColor"></path>
                                    </svg>
                                </button>
                                <button id="play-btn" class="btn-icon lg btn-gradient-success" title="Play">
                                    <svg viewBox="0 0 24 24" fill="none">
                                        <path d="M21.4086 9.35258C23.5305 10.5065 23.5305 13.4935 21.4086 14.6474L8.59662 21.6145C6.53435 22.736 4 21.2763 4 18.9671L4 5.0329C4 2.72368 6.53435 1.26402 8.59661 2.38548L21.4086 9.35258Z" fill="currentColor"></path>
                                    </svg>
                                </button>
                                <button id="panic-btn" class="btn-icon btn-gradient-warning" title="Panic">
                                    <svg viewBox="0 0 24 24" fill="none">
                                        <path d="M22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12Z" fill="currentColor"></path>
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M12 7.25C12.4142 7.25 12.75 7.58579 12.75 8V11.6893L15.0303 13.9697C15.3232 14.2626 15.3232 14.7374 15.0303 15.0303C14.7374 15.3232 14.2626 15.3232 13.9697 15.0303L11.4697 12.5303C11.329 12.3897 11.25 12.1989 11.25 12V8C11.25 7.58579 11.5858 7.25 12 7.25Z" fill="#1C274C"></path>
                                    </svg>
                                </button>
                                <button id="next-btn" class="btn-icon btn-outline-glass" title="Next">
                                    <svg viewBox="0 0 24 24" fill="none">
                                        <path d="M16.6598 14.6474C18.4467 13.4935 18.4467 10.5065 16.6598 9.35258L5.87083 2.38548C4.13419 1.26402 2 2.72368 2 5.0329V18.9671C2 21.2763 4.13419 22.736 5.87083 21.6145L16.6598 14.6474Z" fill="currentColor"></path>
                                        <path d="M22.75 5C22.75 4.58579 22.4142 4.25 22 4.25C21.5858 4.25 21.25 4.58579 21.25 5V19C21.25 19.4142 21.5858 19.75 22 19.75C22.4142 19.75 22.75 19.4142 22.75 19V5Z" fill="currentColor"></path>
                                    </svg>
                                </button>
                            </div>
                        </section>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="vstack gap-4">
                        <section class="glass-card p-4 p-md-5">
                            <h2 class="app-card-title mb-4 text-center">Cue Navigation</h2>
                            <div class="d-flex justify-content-center mb-4">
                                <button id="reset-btn" class="btn btn-soft-secondary btn-modern">
                                    <span class="me-2">‚Üª</span>Reset
                                </button>
                            </div>
                            <div class="vstack gap-3">
                                <div class="d-flex gap-2">
                                    <select id="cue-select" class="form-select form-select-glass">
                                        <option value="">Select Cue</option>
                                    </select>
                                    <button id="load-cues-btn" class="btn btn-soft-secondary btn-modern" title="Refresh Cue List">üîÑ</button>
                                </div>
                                <button id="select-cue-btn" class="btn btn-gradient-primary btn-modern w-100">Go to Selected Cue</button>
                            </div>
                        </section>

                        <section class="glass-card p-4 p-md-5 volume-section">
                            <div class="d-flex align-items-center justify-content-between mb-4">
                                <h2 class="app-card-title mb-0 text-center">Volume Control</h2>
                                <button id="refresh-volume-btn" class="btn btn-soft-secondary btn-sm" title="Refresh Volume">üîÑ</button>
                            </div>
                            <div id="volume-unavailable" class="text-center py-4 hidden">No audio cue selected</div>
                            <div id="volume-controls" class="vstack gap-4">
                                <div class="volume-control-group">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="text-soft text-uppercase small fw-semibold">Master</span>
                                        <span id="master-level-display" class="badge volume-badge volume-muted">-60dB</span>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <input type="range" id="master-volume-slider" min="-60" max="12" value="-60" step="0.1" class="form-range volume-slider flex-grow-1" data-channel="master">
                                        <button class="btn btn-outline-glass btn-sm mute-btn" data-channel="master" title="Mute">üîá</button>
                                    </div>
                                </div>
                                <div class="volume-control-group">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="text-soft text-uppercase small fw-semibold">Channel 1</span>
                                        <span id="ch1-level-display" class="badge volume-badge volume-muted">-60dB</span>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <input type="range" id="ch1-volume-slider" min="-60" max="12" value="-60" step="0.1" class="form-range volume-slider flex-grow-1" data-channel="channel1">
                                        <button class="btn btn-outline-glass btn-sm mute-btn" data-channel="channel1" title="Mute">üîá</button>
                                    </div>
                                </div>
                                <div class="volume-control-group">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="text-soft text-uppercase small fw-semibold">Channel 2</span>
                                        <span id="ch2-level-display" class="badge volume-badge volume-muted">-60dB</span>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <input type="range" id="ch2-volume-slider" min="-60" max="12" value="-60" step="0.1" class="form-range volume-slider flex-grow-1" data-channel="channel2">
                                        <button class="btn btn-outline-glass btn-sm mute-btn" data-channel="channel2" title="Mute">üîá</button>
                                    </div>
                                </div>
                                <div class="border-top border-secondary pt-3 mt-2 text-center small text-soft">
                                    <span id="volume-cue-info">No cue selected</span>
                                </div>
                            </div>
                        </section>

                        <section class="glass-card p-4 p-md-5">
                            <h2 class="app-card-title mb-4 text-center">Network</h2>
                            <div class="info-grid">
                                <div class="info-row"><span>Private IP:</span><span id="private-ip" class="badge-soft">192.168.1.x</span></div>
                                <div class="info-row"><span>Port:</span><span id="port" class="badge-soft">XXXX</span></div>
                                <div class="info-row"><span>Node.js:</span><span id="nodejs-version" class="badge-soft">v23.0</span></div>
                            </div>
                        </section>

                        <section class="glass-card p-4 p-md-5">
                            <h2 class="app-card-title mb-4 text-center">Performance</h2>
                            <div class="info-grid">
                                <div class="info-row"><span>Avg Latency:</span><span id="avg-latency" class="badge-soft">0.0ms</span></div>
                                <div class="info-row"><span>Commands:</span><span id="commands-sent" class="badge-soft">0</span></div>
                                <div class="info-row"><span>Error Rate:</span><span id="error-rate" class="badge-soft">0.0%</span></div>
                            </div>
                        </section>

                        <section class="glass-card p-4 p-md-5">
                            <div class="app-footer text-center">
                                <p>QOnCommand - A QLab Remote Control</p>
                                <p>Figure 53¬Æ and QLab¬Æ are registered trademarks of Figure 53, LLC. This project is not affiliated with Figure 53, LLC and this application has not been reviewed nor is it approved by Figure 53, LLC.</p>
                            </div>
                        </section>
                        <br>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/socket.io.min.js"></script>
    <script>
        class QOnCommand {
            constructor() {
                this.connected = false;
                this.currentInstance = null;
                this.socket = null;
                this.socketId = null;
                this.instances = [];
                this.selectedInstanceIndex = null;
                this.selectedWorkspaceId = null;
                this.selectedWorkspaceName = null;
                
                this.initializeElements();
                this.bindEvents();
                this.initSocketListeners();
                this.loadInitialData();
            }
            
            initializeElements() {
                // Status elements
                this.statusIndicator = document.getElementById('status-indicator');
                this.statusText = document.getElementById('status-text');
                this.workspaceName = document.getElementById('workspace-name');
                this.disconnectBtn = document.getElementById('disconnect-btn');
                this.changeWorkspaceBtn = document.getElementById('change-workspace-btn');
                this.connectionStatus = document.getElementById('connection-status');
                
                // Modal elements
                this.workspaceModal = document.getElementById('workspace-modal');
                this.instanceStep = document.getElementById('instance-step');
                this.workspaceStep = document.getElementById('workspace-step');
                this.instanceList = document.getElementById('instance-list');
                this.workspaceList = document.getElementById('workspace-list');
                this.selectedInstanceName = document.getElementById('selected-instance-name');
                this.refreshInstancesBtn = document.getElementById('refresh-instances-btn');
                this.nextStepBtn = document.getElementById('next-step-btn');
                this.backStepBtn = document.getElementById('back-step-btn');
                this.connectWorkspaceBtn = document.getElementById('connect-workspace-btn');
                
                // Current selections
                this.selectedInstanceIndex = null;
                this.selectedWorkspaceId = null;
                
                // Cue elements
                this.currentCueNumber = document.getElementById('current-cue-number');
                this.currentCueName = document.getElementById('current-cue-name');
                this.currentCueType = document.getElementById('current-cue-type');
                this.nextCueNumber = document.getElementById('next-cue-number');
                this.nextCueName = document.getElementById('next-cue-name');
                this.nextCueType = document.getElementById('next-cue-type');
                this.refreshCueBtn = document.getElementById('refresh-cue-btn');
                
                // Transport controls
                this.playBtn = document.getElementById('play-btn');
                this.stopBtn = document.getElementById('stop-btn');
                this.prevBtn = document.getElementById('prev-btn');
                this.nextBtn = document.getElementById('next-btn');
                this.panicBtn = document.getElementById('panic-btn');
                this.resetBtn = document.getElementById('reset-btn');
                
                // Extended controls
                this.cueSelect = document.getElementById('cue-select');
                this.selectCueBtn = document.getElementById('select-cue-btn');
                this.loadCuesBtn = document.getElementById('load-cues-btn');
                
                // Info elements
                this.privateIp = document.getElementById('private-ip');
                this.port = document.getElementById('port');
                this.nodejsVersion = document.getElementById('nodejs-version');
                this.avgLatency = document.getElementById('avg-latency');
                this.commandsSent = document.getElementById('commands-sent');
                this.errorRate = document.getElementById('error-rate');
                
                // Volume control elements
                this.refreshVolumeBtn = document.getElementById('refresh-volume-btn');
                this.volumeUnavailable = document.getElementById('volume-unavailable');
                this.volumeControls = document.getElementById('volume-controls');
                this.masterVolumeSlider = document.getElementById('master-volume-slider');
                this.ch1VolumeSlider = document.getElementById('ch1-volume-slider');
                this.ch2VolumeSlider = document.getElementById('ch2-volume-slider');
                this.masterLevelDisplay = document.getElementById('master-level-display');
                this.ch1LevelDisplay = document.getElementById('ch1-level-display');
                this.ch2LevelDisplay = document.getElementById('ch2-level-display');
                this.volumeCueInfo = document.getElementById('volume-cue-info');
                this.muteButtons = document.querySelectorAll('.mute-btn');
                
                // Volume control state
                this.volumeLevels = { master: -60, channel1: -60, channel2: -60, available: false };
                this.mutedChannels = new Set(); // Track which channels are muted
                this.previousLevels = { master: -60, channel1: -60, channel2: -60 }; // Store levels before muting
                
                // Set initial button states
                this.nextStepBtn.disabled = true;
                this.connectWorkspaceBtn.disabled = true;
            }
            
            bindEvents() {
                // Connection events
                this.disconnectBtn.addEventListener('click', () => {
                    console.log('Disconnect button clicked');
                    this.disconnect();
                });
                
                this.changeWorkspaceBtn.addEventListener('click', () => {
                    console.log('Change workspace button clicked');
                    this.showWorkspaceModal();
                });
                
                // Modal events
                this.refreshInstancesBtn.addEventListener('click', () => {
                    console.log('Refresh instances button clicked');
                    this.refreshInstancesInModal();
                });
                
                this.nextStepBtn.addEventListener('click', () => {
                    console.log('Next step button clicked');
                    this.showWorkspaceStep();
                });
                
                this.backStepBtn.addEventListener('click', () => {
                    console.log('Back step button clicked');
                    this.showInstanceStep();
                });
                
                this.connectWorkspaceBtn.addEventListener('click', () => {
                    console.log('Connect workspace button clicked');
                    this.connectSelectedWorkspace();
                });
                
                // Close modal when clicking outside
                this.workspaceModal.addEventListener('click', (e) => {
                    if (e.target === this.workspaceModal) {
                        this.hideWorkspaceModal();
                    }
                });
                
                // Transport controls with immediate feedback
                this.playBtn.addEventListener('click', () => {
                    console.log('Play button clicked');
                    this.showButtonLoading('play');
                    this.sendCommand('play');
                });
                this.stopBtn.addEventListener('click', () => {
                    console.log('Stop button clicked');
                    this.showButtonLoading('stop');
                    this.sendCommand('stop');
                });
                this.prevBtn.addEventListener('click', () => {
                    console.log('Previous button clicked');
                    this.showButtonLoading('prev');
                    this.sendCommand('previous');
                });
                this.nextBtn.addEventListener('click', () => {
                    console.log('Next button clicked');
                    this.showButtonLoading('next');
                    this.sendCommand('next');
                });
                this.panicBtn.addEventListener('click', () => {
                    console.log('Panic button clicked');
                    this.showButtonLoading('panic');
                    this.sendCommand('panic');
                });
                this.resetBtn.addEventListener('click', () => {
                    console.log('Reset button clicked');
                    this.showButtonLoading('reset');
                    this.sendCommand('reset');
                });
                
                // Cue controls
                this.refreshCueBtn.addEventListener('click', () => {
                    console.log('Refresh cue button clicked');
                    this.updateCueInfo();
                });
                this.selectCueBtn.addEventListener('click', () => {
                    console.log('Select cue button clicked');
                    this.selectCue();
                });
                this.loadCuesBtn.addEventListener('click', () => {
                    console.log('Load cues button clicked');
                    this.loadCueList();
                });
                
                // Volume control events
                this.refreshVolumeBtn.addEventListener('click', () => {
                    console.log('Refresh volume button clicked');
                    this.updateVolumeInfo();
                });
                
                // Volume slider events with throttling to prevent flooding QLab
                let volumeUpdateTimeout = null;
                const handleVolumeChange = (slider) => {
                    const channel = slider.dataset.channel;
                    const level = parseInt(slider.value);
                    
                    // Update display immediately for responsiveness
                    this.updateVolumeDisplay(channel, level);
                    
                    // Throttle actual OSC updates to prevent flooding
                    if (volumeUpdateTimeout) {
                        clearTimeout(volumeUpdateTimeout);
                    }
                    
                    volumeUpdateTimeout = setTimeout(() => {
                        this.setVolumeLevel(channel, level);
                    }, 150); // Wait 150ms after user stops dragging
                };
                
                this.masterVolumeSlider.addEventListener('input', (e) => handleVolumeChange(e.target));
                this.ch1VolumeSlider.addEventListener('input', (e) => handleVolumeChange(e.target));
                this.ch2VolumeSlider.addEventListener('input', (e) => handleVolumeChange(e.target));
                
                // Mute button events
                this.muteButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const channel = btn.dataset.channel;
                        this.toggleMute(channel);
                    });
                });
            }
            
            async loadInitialData() {
                // Load system info
                this.privateIp.textContent = window.location.hostname;
                this.port.textContent = window.location.port || '5000';
                this.nodejsVersion.textContent = 'v23.0';
                
                // Clear performance history on page load and update display
                try {
                    const response = await fetch('/api/clear_performance', {
                        method: 'POST'
                    });
                    const data = await response.json();
                    if (data.success) {
                        // Update performance display immediately
                        this.avgLatency.textContent = '0.0ms';
                        this.commandsSent.textContent = '0';
                        this.errorRate.textContent = '0.0%';
                        console.log('Performance history cleared and display updated');
                    }
                } catch (error) {
                    console.error('Failed to clear performance history:', error);
                }
                
                // Set initial disconnected state
                this.updateStatus('disconnected', 'Disconnected');
                this.workspaceName.textContent = 'No workspace connected';
                this.disconnectBtn.style.display = 'none';
                this.updateCueDisplay(
                    { number: '--', name: 'Not connected', type: 'unknown' },
                    { number: '--', name: 'Not connected', type: 'unknown' }
                );
                
                // Set initial status - not attempting to connect
                this.connectionStatus.textContent = 'Click "Change Workspace" to connect to QLab';
                this.connectionStatus.className = 'connection-status alert alert-danger text-center';
                
                // Show change workspace button by default
                this.changeWorkspaceBtn.style.display = 'block';
            }
            
            async refreshInstances() {
                try {
                    const response = await fetch('/api/refresh_instances', {
                        method: 'POST'
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        this.instances = data.instances || [];
                        
                        if (this.instances.length === 0) {
                            this.updateStatus('disconnected', 'QLab not running');
                        }
                    } else {
                        console.error('Failed to refresh instances:', data.error);
                        this.updateStatus('disconnected', data.error);
                    }
                } catch (error) {
                    console.error('Error refreshing instances:', error);
                    this.updateStatus('disconnected', 'Connection error');
                }
            }
            
            async connectToInstance(instanceId) {
                try {
                    console.log(`Attempting to connect to instance ${instanceId}...`);
                    const response = await fetch(`/api/connect/${instanceId}`, {
                        method: 'POST',
                        headers: this.getRequestHeaders()
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        console.log('Successfully connected to QLab workspace:', data);
                        this.connected = true;
                        this.currentInstance = data;
                        this.updateStatus('connected', 'Connected');
                        this.workspaceName.textContent = data.name;
                        
                        // Update connection status
                        this.connectionStatus.textContent = 'QLab is running';
                        this.connectionStatus.className = 'connection-status alert alert-success text-center';
                        
                        // Update cue info immediately
                        if (data.currentCue && data.nextCue) {
                            this.updateCueDisplay(data.currentCue, data.nextCue);
                        } else {
                            // Fetch fresh cue info
                            await this.updateCueInfo();
                        }
                        
                        // Fetch volume info immediately after connection
                        this.updateVolumeInfo();
                        
                        // Fetch cue list immediately after connection (fallback for real-time updates)
                        this.fetchCueList();
                        
                        // Show disconnect button, hide change workspace button
                        this.disconnectBtn.style.display = 'block';
                        this.changeWorkspaceBtn.style.display = 'none';
                    } else {
                        console.error('Failed to connect:', data.error);
                        this.updateStatus('disconnected', data.error);
                        this.workspaceName.textContent = 'Connection failed';
                        this.disconnectBtn.style.display = 'none';
                        this.updateCueDisplay(
                            { number: '--', name: 'Connection failed', type: 'unknown' },
                            { number: '--', name: 'Connection failed', type: 'unknown' }
                        );
                    }
                } catch (error) {
                    console.error('Error connecting:', error);
                    this.updateStatus('disconnected', 'Connection error');
                    this.workspaceName.textContent = 'Connection error';
                    this.disconnectBtn.style.display = 'none';
                    this.updateCueDisplay(
                        { number: '--', name: 'Connection error', type: 'unknown' },
                        { number: '--', name: 'Connection error', type: 'unknown' }
                    );
                }
            }
            
            async disconnect() {
                try {
                    const response = await fetch('/api/disconnect', {
                        method: 'POST',
                        headers: this.getRequestHeaders()
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        this.connected = false;
                        this.currentInstance = null;
                        this.updateStatus('disconnected', 'Disconnected');
                        this.workspaceName.textContent = 'No workspace connected';
                        
                        // Update connection status
                        this.connectionStatus.textContent = 'Click "Change Workspace" to connect to QLab';
                        this.connectionStatus.className = 'connection-status alert alert-danger text-center';
                        
                        // Show change workspace button, hide disconnect button
                        this.disconnectBtn.style.display = 'none';
                        this.changeWorkspaceBtn.style.display = 'block';
                        
                        // Reset cue display
                        this.updateCueDisplay(
                            { number: '--', name: 'Not connected', type: 'unknown' },
                            { number: '--', name: 'Not connected', type: 'unknown' }
                        );
                        
                        // Reset volume display
                        this.showVolumeUnavailable('Not connected');
                        
                        // Clear cue list
                        this.cueSelect.innerHTML = '<option value="">Select Cue</option>';
                    }
                } catch (error) {
                    console.error('Error disconnecting:', error);
                }
            }
            
            // Show immediate visual feedback for button presses
            showButtonLoading(buttonType) {
                const buttonMap = {
                    'play': this.playBtn,
                    'stop': this.stopBtn,
                    'prev': this.prevBtn,
                    'next': this.nextBtn,
                    'panic': this.panicBtn,
                    'reset': this.resetBtn
                };
                
                const button = buttonMap[buttonType];
                if (!button) return;
                
                // Find the SVG element
                const svg = button.querySelector('svg');
                if (!svg) return;
                
                // Store original SVG
                const originalSVG = svg.outerHTML;
                
                // Show loading spinner
                svg.outerHTML = '<div class="spinner-border text-light spinner-border-sm" role="status"></div>';
                button.disabled = true;
                button.style.opacity = '0.7';
                
                // Reset after short delay
                setTimeout(() => {
                    const spinner = button.querySelector('.spinner-border');
                    if (spinner) {
                        spinner.outerHTML = originalSVG;
                    }
                    button.disabled = false;
                    button.style.opacity = '1';
                }, 300); // Quick visual feedback
            }

            // Helper method to create headers with client ID
            getRequestHeaders() {
                return {
                    'Content-Type': 'application/json',
                    'X-Client-Id': this.socketId || 'default'
                };
            }

            async sendCommand(command) {
                if (!this.connected) {
                    alert('Not connected to QLab');
                    return;
                }

                try {
                    // Send command without waiting for response to make UI feel instant
                    fetch(`/api/command/${command}`, {
                        method: 'POST',
                        headers: this.getRequestHeaders()
                    }).then(response => response.json()).then(data => {
                        if (!data.success) {
                            console.error(`Command ${command} failed:`, data.error);
                        }
                    }).catch(error => {
                        console.error(`Error sending command ${command}:`, error);
                    });
                } catch (error) {
                    console.error(`Error sending command ${command}:`, error);
                }
            }
            
            async selectCue() {
                const cueId = this.cueSelect.value;
                if (!cueId) {
                    alert('Please select a cue');
                    return;
                }
                
                try {
                    const response = await fetch('/api/skip', {
                        method: 'POST',
                        headers: this.getRequestHeaders(),
                        body: JSON.stringify({ cue: cueId })
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        console.log('Successfully selected cue');
                    } else {
                        console.error('Failed to select cue:', data.error);
                        alert(`Failed to select cue: ${data.error}`);
                    }
                } catch (error) {
                    console.error('Error selecting cue:', error);
                    alert(`Error: ${error.message}`);
                }
            }
            
            async updateCueInfo() {
                if (!this.connected) return;
                
                try {
                    const response = await fetch('/api/cue_info');
                    const data = await response.json();
                    
                    if (data.success) {
                        this.updateCueDisplay(data.current, data.next);
                    }
                } catch (error) {
                    console.error('Error updating cue info:', error);
                }
            }
            
            // Load cue list manually with user feedback
            async loadCueList() {
                if (!this.connected) {
                    alert('Not connected to QLab');
                    return;
                }
                
                // Show loading state
                this.loadCuesBtn.disabled = true;
                this.loadCuesBtn.textContent = '‚è≥';
                
                try {
                    await this.fetchCueList();
                } finally {
                    // Restore button state
                    this.loadCuesBtn.disabled = false;
                    this.loadCuesBtn.textContent = 'üîÑ';
                }
            }
            
            // Fetch cue list from server
            async fetchCueList() {
                try {
                    const response = await fetch('/api/cues', {
                        headers: this.getRequestHeaders()
                    });
                    const data = await response.json();
                    
                    if (data.cues && data.cues.length > 0) {
                        this.populateCueList(data.cues);
                        console.log(`Fetched ${data.cues.length} cues for scene selector`);
                        return true;
                    } else {
                        console.log('No cues received, attempting connection recovery...');
                        // Try to restore connection if no cues received
                        if (!this.connected) {
                            await this.attemptDirectConnection();
                            // Retry after connection attempt
                            const retryResponse = await fetch('/api/cues', {
                                headers: this.getRequestHeaders()
                            });
                            const retryData = await retryResponse.json();
                            if (retryData.cues && retryData.cues.length > 0) {
                                this.populateCueList(retryData.cues);
                                console.log(`Fetched ${retryData.cues.length} cues after recovery`);
                                return true;
                            }
                        }
                        return false;
                    }
                } catch (error) {
                    console.error('Error fetching cue list:', error);
                    // Try connection recovery on error
                    try {
                        await this.attemptDirectConnection();
                        console.log('Connection recovery attempted');
                    } catch (recoveryError) {
                        console.error('Connection recovery failed:', recoveryError);
                        alert('Failed to load cue list and recover connection');
                    }
                    return false;
                }
            }
            
            // Populate cue select dropdown
            populateCueList(cues) {
                this.cueSelect.innerHTML = '<option value="">Select Cue</option>';
                cues.forEach(cue => {
                    const option = document.createElement('option');
                    option.value = cue.id;
                    option.textContent = `${cue.number} - ${cue.originalName}`;
                    this.cueSelect.appendChild(option);
                });
            }
            
            updateCueDisplay(current, next) {
                // Check if we're disconnected and show appropriate message
                const applyCueBadge = (element, cueType, variant) => {
                    const normalized = (cueType || 'unknown').toLowerCase();
                    element.className = 'badge cue-badge';
                    if (variant === 'next') {
                        element.classList.add('cue-badge-next');
                    }
                    if (normalized === 'audio') {
                        element.classList.add('cue-badge-audio');
                    }
                    element.textContent = normalized;
                };

                if (!this.connected) {
                    this.currentCueNumber.textContent = '--';
                    this.currentCueName.textContent = 'Not connected';
                    applyCueBadge(this.currentCueType, 'unknown');

                    this.nextCueNumber.textContent = '--';
                    this.nextCueName.textContent = 'Not connected';
                    applyCueBadge(this.nextCueType, 'unknown', 'next');
                    return;
                }

                this.currentCueNumber.textContent = current.number || '--';
                this.currentCueName.textContent = current.name || 'Unknown';
                applyCueBadge(this.currentCueType, current.type);

                this.nextCueNumber.textContent = next.number || '--';
                this.nextCueName.textContent = next.name || 'Unknown';
                applyCueBadge(this.nextCueType, next.type, 'next');
            }
            
            updateStatus(status, text) {
                if (status === 'connected') {
                    this.statusIndicator.className = 'status-dot status-dot-pulse bg-success';
                    this.statusText.className = 'fw-semibold text-success';
                } else {
                    this.statusIndicator.className = 'status-dot status-dot-pulse bg-danger';
                    this.statusText.className = 'fw-semibold text-soft';
                }
                this.statusText.textContent = text;
            }
            
            // Volume Control Methods
            async updateVolumeInfo() {
                if (!this.connected) {
                    this.showVolumeUnavailable('Not connected to QLab');
                    return;
                }
                
                try {
                    const response = await fetch('/api/audio_levels', {
                        headers: this.getRequestHeaders()
                    });
                    const data = await response.json();
                    
                    if (data.success && data.levels.available) {
                        this.volumeLevels = data.levels;
                        this.updateVolumeControls(data.levels);
                        this.showVolumeControls();
                    } else {
                        this.showVolumeUnavailable(data.levels.error || 'No audio cue selected');
                    }
                } catch (error) {
                    console.error('Error updating volume info:', error);
                    this.showVolumeUnavailable('Error loading volume levels');
                }
            }
            
            updateVolumeControls(levels) {
                // Update sliders and displays
                this.masterVolumeSlider.value = levels.master;
                this.ch1VolumeSlider.value = levels.channel1;
                this.ch2VolumeSlider.value = levels.channel2;
                
                this.updateVolumeDisplay('master', levels.master);
                this.updateVolumeDisplay('channel1', levels.channel1);
                this.updateVolumeDisplay('channel2', levels.channel2);
                
                // Update cue info
                if (levels.cueName) {
                    this.volumeCueInfo.textContent = `${levels.cueName}`;
                } else {
                    this.volumeCueInfo.textContent = 'Audio cue selected';
                }
            }
            
            updateVolumeDisplay(channel, level) {
                let displayElement;
                switch (channel) {
                    case 'master':
                        displayElement = this.masterLevelDisplay;
                        this.volumeLevels.master = level;
                        break;
                    case 'channel1':
                        displayElement = this.ch1LevelDisplay;
                        this.volumeLevels.channel1 = level;
                        break;
                    case 'channel2':
                        displayElement = this.ch2LevelDisplay;
                        this.volumeLevels.channel2 = level;
                        break;
                }
                
                if (displayElement) {
                    displayElement.textContent = `${level}dB`;
                    displayElement.className = 'badge volume-badge';

                    if (level <= -60) {
                        displayElement.classList.add('volume-muted');
                    } else if (level < -30) {
                        displayElement.classList.add('volume-low');
                    } else if (level < -10) {
                        displayElement.classList.add('volume-mid');
                    } else if (level < 0) {
                        displayElement.classList.add('volume-high');
                    } else {
                        displayElement.classList.add('volume-hot');
                    }
                }
            }
            
            async setVolumeLevel(channel, level) {
                if (!this.connected) return;
                
                try {
                    const response = await fetch('/api/audio_level', {
                        method: 'POST',
                        headers: this.getRequestHeaders(),
                        body: JSON.stringify({ channel, level })
                    });
                    
                    const data = await response.json();
                    if (!data.success) {
                        console.error(`Failed to set ${channel} volume:`, data.error);
                        // Revert slider to previous value
                        this.updateVolumeInfo();
                    }
                } catch (error) {
                    console.error(`Error setting ${channel} volume:`, error);
                    // Revert slider to previous value
                    this.updateVolumeInfo();
                }
            }
            
            toggleMute(channel) {
                const isMuted = this.mutedChannels.has(channel);
                
                if (isMuted) {
                    // Unmute: restore previous level
                    const previousLevel = this.previousLevels[channel] || -10; // Default to -10dB if no previous level
                    this.setVolumeLevel(channel, previousLevel);
                    this.mutedChannels.delete(channel);
                    
                    // Update slider
                    const slider = document.querySelector(`[data-channel="${channel}"]`);
                    if (slider && slider.type === 'range') {
                        slider.value = previousLevel;
                        this.updateVolumeDisplay(channel, previousLevel);
                    }
                    
                    // Update button
                    const muteBtn = document.querySelector(`.mute-btn[data-channel="${channel}"]`);
                    if (muteBtn) {
                        muteBtn.textContent = 'üîá';
                        muteBtn.title = 'Mute';
                        muteBtn.classList.remove('btn-danger');
                        muteBtn.classList.add('btn-outline-glass');
                    }
                } else {
                    // Mute: store current level and set to -60dB (muted)
                    this.previousLevels[channel] = this.volumeLevels[channel];
                    this.setVolumeLevel(channel, -60);
                    this.mutedChannels.add(channel);
                    
                    // Update slider
                    const slider = document.querySelector(`[data-channel="${channel}"]`);
                    if (slider && slider.type === 'range') {
                        slider.value = -60;
                        this.updateVolumeDisplay(channel, -60);
                    }
                    
                    // Update button
                    const muteBtn = document.querySelector(`.mute-btn[data-channel="${channel}"]`);
                    if (muteBtn) {
                        muteBtn.textContent = 'üîä';
                        muteBtn.title = 'Unmute';
                        muteBtn.classList.remove('btn-outline-glass');
                        muteBtn.classList.add('btn-danger');
                    }
                }
            }
            
            showVolumeControls() {
                this.volumeUnavailable.classList.add('hidden');
                this.volumeControls.classList.remove('hidden');
            }
            
            showVolumeUnavailable(message) {
                this.volumeUnavailable.textContent = message;
                this.volumeUnavailable.classList.remove('hidden');
                this.volumeControls.classList.add('hidden');
            }
            
            // Initialize Socket.io listeners for real-time updates
            initSocketListeners() {
                this.socket = io();
                // Handle socket connection events
                this.socket.on('connect', () => {
                    this.socketId = this.socket.id;
                    console.log(`Socket.io connected to server with ID: ${this.socketId}`);
                    
                    // If we were previously connected, try to restore connection
                    if (this.connected && this.currentInstance) {
                        console.log('Attempting to restore QLab connection after socket reconnect...');
                        this.attemptDirectConnection();
                    }
                });
                this.socket.on('disconnect', () => {
                    console.log('Socket.io disconnected from server');
                    // Mark as disconnected but don't reset UI completely - allow for reconnection
                    this.updateStatus('disconnected', 'Reconnecting...');
                });
                // Receive server info once
                this.socket.on('serverInfo', ({ ip, port, nodeVersion }) => {
                    this.privateIp.textContent = ip;
                    this.port.textContent = port;
                    this.nodejsVersion.textContent = nodeVersion;
                });
                // Listen for cue info updates
                this.socket.on('cueInfo', ({ current, next }) => {
                    // Only update cue info if we're connected to QLab
                    if (this.connected) {
                        this.updateCueDisplay(current, next);
                    }
                });
                // Listen for performance updates
                this.socket.on('performance', data => {
                    this.avgLatency.textContent = `${data.average_latency}ms`;
                    this.commandsSent.textContent = data.commands_sent;
                    this.errorRate.textContent = `${data.error_rate}%`;
                });
                // Listen for cue list updates
                this.socket.on('cueList', ({ cues }) => {
                    this.populateCueList(cues);
                });
                
                // Listen for volume level updates
                this.socket.on('volumeLevels', ({ levels }) => {
                    if (this.connected && levels.available) {
                        this.volumeLevels = levels;
                        this.updateVolumeControls(levels);
                        this.showVolumeControls();
                    } else {
                        this.showVolumeUnavailable(levels.error || 'No audio cue selected');
                    }
                });
            }
            
            // Workspace Modal Functions
            showWorkspaceModal() {
                console.log('Opening workspace modal');
                this.workspaceModal.classList.remove('hidden');
                this.showInstanceStep();
            }
            
            hideWorkspaceModal() {
                this.workspaceModal.classList.add('hidden');
                this.selectedInstanceIndex = null;
                this.selectedWorkspaceId = null;
                this.selectedWorkspaceName = null;
                this.connectWorkspaceBtn.disabled = true;
            }
            
            showInstanceStep() {
                console.log('Showing instance step');
                this.instanceStep.classList.remove('hidden');
                this.workspaceStep.classList.add('hidden');
                this.refreshInstancesInModal();
            }
            
            showWorkspaceStep() {
                console.log('Showing workspace step, selectedInstanceIndex:', this.selectedInstanceIndex);
                if (this.selectedInstanceIndex === null) return;
                
                this.instanceStep.classList.add('hidden');
                this.workspaceStep.classList.remove('hidden');
                
                // Update the selected instance name display
                const selectedInstance = this.instances[this.selectedInstanceIndex];
                console.log('Selected instance:', selectedInstance);
                this.selectedInstanceName.textContent = selectedInstance ? selectedInstance.name : 'Unknown Instance';
                
                this.refreshWorkspacesInModal();
            }
            
            async refreshInstancesInModal() {
                        this.instanceList.innerHTML = '<div class="text-center text-soft py-4">Loading instances...</div>';
                
                await this.refreshInstances();
                
                console.log('Instances loaded:', this.instances);
                this.instanceList.innerHTML = '';
                
                if (this.instances.length === 0) {
                    this.instanceList.innerHTML = '<div class="text-center text-danger py-4">QLab not running or no instances found</div>';
                    return;
                }
                
                this.instances.forEach((instance, index) => {
                    const div = document.createElement('div');
                    div.className = 'option-card';
                    div.setAttribute('role', 'button');
                    div.innerHTML = `
                        <div class="fw-semibold">${instance.name}</div>
                        <div class="small text-soft">${instance.ip || 'localhost'}</div>
                    `;
                    div.addEventListener('click', () => {
                        this.instanceList.querySelectorAll('.option-card').forEach(opt => opt.classList.remove('selected'));
                        div.classList.add('selected');
                        this.selectedInstanceIndex = index;
                        this.nextStepBtn.disabled = false;
                    });
                    
                    this.instanceList.appendChild(div);
                });
            }
            
            async refreshWorkspacesInModal() {
                if (this.selectedInstanceIndex === null) return;
                
                this.workspaceList.innerHTML = '<div class="text-center text-soft py-4">Loading workspaces...</div>';
                
                try {
                    const response = await fetch(`/api/instances/${this.selectedInstanceIndex}/workspaces`, {
                        headers: this.getRequestHeaders()
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    this.workspaceList.innerHTML = '';
                    
                    if (!data.workspaces || data.workspaces.length === 0) {
                        this.workspaceList.innerHTML = '<div class="text-center text-danger py-4">No workspaces found on this instance</div>';
                        return;
                    }
                    
                    data.workspaces.forEach((workspace, index) => {
                        const div = document.createElement('div');
                        div.className = 'option-card';
                        div.setAttribute('role', 'button');
                        div.innerHTML = `
                            <div class="fw-semibold">${workspace.name || workspace.id}</div>
                            <div class="small text-soft">ID: ${workspace.id}</div>
                        `;
                        div.addEventListener('click', () => {
                            this.workspaceList.querySelectorAll('.option-card').forEach(opt => opt.classList.remove('selected'));
                            div.classList.add('selected');
                            this.selectedWorkspaceId = workspace.id;
                            this.selectedWorkspaceName = workspace.name;
                            this.connectWorkspaceBtn.disabled = false;
                        });
                        
                        this.workspaceList.appendChild(div);
                    });
                } catch (error) {
                    console.error('Failed to load workspaces:', error);
                    this.workspaceList.innerHTML = '<div class="text-center text-danger py-4">Failed to load workspaces</div>';
                }
            }
            
            async connectSelectedWorkspace() {
                if (this.selectedInstanceIndex === null || this.selectedWorkspaceId === null) return;
                
                this.connectWorkspaceBtn.disabled = true;
                this.connectWorkspaceBtn.textContent = 'Connecting...';
                
                try {
                    const response = await fetch(`/api/connect/${this.selectedInstanceIndex}/${this.selectedWorkspaceId}`, {
                        method: 'POST',
                        headers: this.getRequestHeaders()
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    if (data.success) {
                        console.log('Successfully connected to QLab workspace:', data);
                        this.connected = true;
                        this.currentInstance = data;
                        this.updateStatus('connected', 'Connected');
                        
                        // Get device and workspace names
                        const deviceName = this.instances[this.selectedInstanceIndex].name;
                        const workspaceName = this.selectedWorkspaceName || 'Unknown Workspace';
                        const workspaceUUID = this.selectedWorkspaceId;
                        
                        // Update workspace display with device name, workspace name, and UUID
                        this.workspaceName.innerHTML = `
                            <div class="fw-semibold text-white">${deviceName}</div>
                            <div class="small text-soft">${workspaceName}</div>
                            <div class="small text-soft opacity-75 font-monospace">${workspaceUUID}</div>
                        `;
                        
                        // Update connection status
                        this.connectionStatus.textContent = 'QLab is running';
                        this.connectionStatus.className = 'connection-status alert alert-success text-center';
                        
                        this.hideWorkspaceModal();
                        this.loadCueList();
                        
                        // Update volume info after connection
                        setTimeout(() => {
                            this.updateVolumeInfo();
                        }, 500);
                    } else {
                        throw new Error(data.error || 'Connection failed');
                    }
                } catch (error) {
                    console.error('Failed to connect to workspace:', error);
                    alert('Failed to connect to workspace: ' + error.message);
                } finally {
                    this.connectWorkspaceBtn.disabled = false;
                    this.connectWorkspaceBtn.textContent = 'Connect';
                }
            }
            
            async attemptDirectConnection() {
                try {
                    // Try connecting directly using the new endpoint
                    const response = await fetch('/api/connect_direct', {
                        method: 'POST',
                        headers: this.getRequestHeaders()
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            this.connected = true;
                            this.currentInstance = {
                                name: data.name,
                                ip: data.ip,
                                workspace_id: data.workspace_id
                            };
                            this.updateStatus('connected', `Connected to ${data.name}`);
                            this.workspaceName.textContent = data.name;
                            this.connectionStatus.textContent = 'Connected to QLab';
                            this.connectionStatus.className = 'connection-status alert alert-success text-center';
                            this.disconnectBtn.style.display = 'inline-block';
                            this.changeWorkspaceBtn.style.display = 'none';
                            
                            // Update cue display
                            this.updateCueDisplay(data.currentCue, data.nextCue);
                            
                            // Update volume info
                            setTimeout(() => {
                                this.updateVolumeInfo();
                            }, 500);
                            
                            // Fetch cue list immediately after connection (fallback for real-time updates)
                            this.fetchCueList();
                            
                            console.log('Successfully connected to QLab');
                        } else {
                            throw new Error(data.error || 'Connection failed');
                        }
                    } else {
                        throw new Error('HTTP error: ' + response.status);
                    }
                } catch (error) {
                    console.error('Direct connection failed:', error);
                    this.connectionStatus.textContent = 'QLab not available - Click "Change Workspace" to retry';
                    this.connectionStatus.className = 'connection-status alert alert-danger text-center';
                    this.changeWorkspaceBtn.style.display = 'inline-block';
                }
            }
        }
        
        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new QOnCommand();
        });
    </script>
</body>
</html>
